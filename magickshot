#!/bin/sh

dir=~/.local/share/magickshot/Screenshots
title="$(date +'%Y-%m-%d_%R:%S')"
dir2=$dir/import-$title.png

main() {
    parse_opts "$@"

    if [ -n "$help" ]; then
	help
    elif [ -n "$selection" -a -n "$window" ]; then
	xwdshot
    elif [ -n "$selection" ]; then
	screenshot
    elif [ -n "$window" ]; then
	if [ -n "$2" ]; then
	    screenshot -window "$2"
	else
	    screenshot -window root
	fi
    elif [ $# -eq 0 ]; then
	screenshot -window root
    else
	help
    fi
}

pl() {
    setsid mpv --really-quiet --pause=no --keep-open=no "$@" &>/dev/null
}

sound() {
    sound_dir=/usr/share/sounds/deepin/stereo

    if [ -d $sound_dir ]; then
	sound_1=$sound_dir/camera-shutter.wav
	sound_2=$sound_dir/dialog-error.wav

	pl $sound_1 || pl $sound_2
    fi
}

screenshot() {
    [ "$(pidof unclutter xbanish | wc -l)" -ge 1 ] && xdotool mousemove_relative 1 0 ; import "$@" $dir2 && sound
}

xwdshot() {
    xwd -nobdrs | convert xwd:- $dir2 && sound
}

help() {
    printf "Usage:	magickshot [options]

Options:
 -s|--selection │ Take a screenshot of the selection
 -w|--window    │ Take a screenshot of the specified window (default is root)
 -h|--help	│ Print this help message and exit

Use both the selection and window arguments at the same time and you will be able to use the cursor to select a specific window to take a screenshot of.
\n"
}

parse_opts() {
    while [ $# -gt 0 ]; do
        key="$1"
	case $key in
	-h|--help)
	    help=1
	    shift
	    ;;
	-s|--selection)
	    selection=1
	    shift
	    ;;
	-w|--window)
	    window=1
	    shift
	    ;;
	-sw|-ws)
	    selection=1
	    window=1
	    shift
	    ;;
        *)
            shift
            ;;
        esac
    done
}

main "$@"
